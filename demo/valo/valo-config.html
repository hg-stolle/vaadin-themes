<link rel="import" href="../../../polymer/polymer-element.html">
<link rel="import" href="../../../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../polymer/lib/elements/dom-repeat.html">
<script src="../../../TinyColor/tinycolor.js"></script>

<dom-module id="valo-config">
  <template>
    <style include="valo-colors">
      :host {
        display: block;
        position: fixed;
        top: 0;
        right: 0;
        z-index: 20;
        background-color: var(--valo-base-color);
        box-shadow: 0 4px 24px var(--valo-black-30pct);
        font-size: 12px;
        padding: 1em;
        border-bottom-left-radius: 4px;
      }

      summary {
        outline: none;
        cursor: pointer;
      }

      .color-pickers {
        display: flex;
      }

      .color-pickers > div {
        padding: 0 1em 1em;
      }

      .color-pickers h4,
      .color-pickers h5 {
        margin: 1em 0 0;
      }

      .light-controls {
        background-color: var(--valo-base-color);
      }

      .color input {
        width: 16px;
        height: 16px;
        padding: 0;
        border: 0;
        background: transparent;
        vertical-align: middle;
        cursor: pointer;
      }

      .color input::-webkit-color-swatch-wrapper {
        padding: 0;
      }

      .color input::-webkit-color-swatch {
        border-radius: 50%;
        border-color: var(--valo-contrast);
      }

      .color button {
        background: var(--valo-contrast-60pct, rgba(0,0,0,0.6));
        color: var(--valo-base-color, #fff);
        border: 0;
        margin: 0;
        padding: 0;
        width: 16px;
        height: 16px;
        font: inherit;
        font-size: 14px;
        line-height: 14px;
        font-weight: 600;
        overflow: hidden;
        vertical-align: middle;
        border-radius: 50%;
      }

      .color button[disabled] {
        opacity: 0;
      }

      .blacks,
      .whites {
        display: flex;
        flex-wrap: wrap;
      }

      .color-swatch {
        display: inline-block;
        text-align: center;
        line-height: 20px;
        width: 20px;
        height: 20px;
        font-size: 10px;
      }

      .light,
      .dark {
        padding: 0.5em;
        display: inline-block;
      }
    </style>

    <details>
      <summary>Customize</summary>
      <div>
        <div class="color-pickers">
          <div class="light-controls" theme="light">
            <h4>Light</h4>

            <dom-repeat items="[[light]]">
              <template>
                <dom-if if="[[!item.hidden]]">
                  <template>
                    <div class="color">
                      <!-- TODO: replace with something cross-browser supported, which also supports copy-paste string values -->
                      <input type="color" path="light.[[index]]" value="[[item.value]]" on-change="_colorChanged">
                      <span>[[_getColorPropertyName(item.name)]]</span>
                      <button on-click="_clearColor" path="light.[[index]]" disabled$="[[!item.userDefined]]" title="Reset (use computed value)">↺</button>
                    </div>
                  </template>
                </dom-if>
              </template>
            </dom-repeat>

            <div class="grayscale">
              <h5>Grayscale</h5>
              <div class="blacks">
                <div class="color-swatch" style="background-color: var(--valo-black); color: var(--valo-white)">100</div>
                <div class="color-swatch" style="background-color: var(--valo-black-90pct); color: var(--valo-white)">90</div>
                <div class="color-swatch" style="background-color: var(--valo-black-80pct); color: var(--valo-white)">80</div>
                <div class="color-swatch" style="background-color: var(--valo-black-70pct); color: var(--valo-white)">70</div>
                <div class="color-swatch" style="background-color: var(--valo-black-60pct); color: var(--valo-white)">60</div>
                <div class="color-swatch" style="background-color: var(--valo-black-50pct); color: var(--valo-white)">50</div>
                <div class="color-swatch" style="background-color: var(--valo-black-40pct); color: var(--valo-contrast)">40</div>
                <div class="color-swatch" style="background-color: var(--valo-black-30pct); color: var(--valo-contrast)">30</div>
                <div class="color-swatch" style="background-color: var(--valo-black-20pct); color: var(--valo-contrast)">20</div>
                <div class="color-swatch" style="background-color: var(--valo-black-10pct); color: var(--valo-contrast)">10</div>
                <div class="color-swatch" style="background-color: var(--valo-black-5pct); color: var(--valo-contrast)">5</div>
              </div>
              <div class="whites">
                <div class="color-swatch" style="background-color: var(--valo-white); color: var(--valo-black)">100</div>
                <div class="color-swatch" style="background-color: var(--valo-white-90pct); color: var(--valo-black)">90</div>
                <div class="color-swatch" style="background-color: var(--valo-white-80pct); color: var(--valo-black)">80</div>
                <div class="color-swatch" style="background-color: var(--valo-white-70pct); color: var(--valo-black)">70</div>
                <div class="color-swatch" style="background-color: var(--valo-white-60pct); color: var(--valo-black)">60</div>
                <div class="color-swatch" style="background-color: var(--valo-white-50pct); color: var(--valo-black)">50</div>
                <div class="color-swatch" style="background-color: var(--valo-white-40pct); color: var(--valo-contrast)">40</div>
                <div class="color-swatch" style="background-color: var(--valo-white-30pct); color: var(--valo-contrast)">30</div>
                <div class="color-swatch" style="background-color: var(--valo-white-20pct); color: var(--valo-contrast)">20</div>
                <div class="color-swatch" style="background-color: var(--valo-white-10pct); color: var(--valo-contrast)">10</div>
                <div class="color-swatch" style="background-color: var(--valo-white-5pct); color: var(--valo-contrast)">5</div>
              </div>
            </div>
          </div>

          <div class="dark-controls" theme="dark">
            <h4>Dark</h4>

            <dom-repeat items="[[dark]]">
              <template>
                <dom-if if="[[!item.hidden]]">
                  <template>
                    <div class="color">
                      <!-- TODO: replace with something cross-browser supported, which also supports copy-paste string values -->
                      <input type="color" path="dark.[[index]]" value="[[item.value]]" on-change="_colorChanged">
                      <span>[[_getColorPropertyName(item.name)]]</span>
                      <button on-click="_clearColor" path="dark.[[index]]" disabled$="[[!item.userDefined]]" title="Reset (use computed value)">↺</button>
                    </div>
                  </template>
                </dom-if>
              </template>
            </dom-repeat>

            <div class="grayscale"></div>
          </div>
        </div>

        <div>
          Contrast: <input type="range" value="{{contrast::input}}" min="40" max="100">
        </div>
        <div>
          Border radius: <input type="range" value="{{borderRadius::input}}" min="0" max="24">
        </div>
      </div>
    </details>
  </template>
  <script>
    class ValoConfig extends Polymer.Element {
      static get is() {
        return 'valo-config';
      }


      static get properties() {
        return {

          // TODO: save/load settings to/from localStorage

          light: {
            type: Array,
            value: [{
                name: "baseColor",
                value: undefined,
                userDefined: false
              },
              {
                name: "baseTextColor",
                value: undefined,
                userDefined: false
              },
              {
                name: "primaryColor",
                value: undefined,
                userDefined: false
              },
              {
                name: "primaryColor-50pct",
                value: undefined,
                hidden: true
              },
              {
                name: "primaryColor-10pct",
                value: undefined,
                hidden: true
              },
              {
                name: "primaryTextColor",
                value: undefined,
                userDefined: false
              },
              {
                name: "primaryContrastColor",
                value: undefined,
                userDefined: false
              },
              {
                name: "errorColor",
                value: undefined,
                userDefined: false,
              },
              {
                name: "errorColor-50pct",
                value: undefined,
                hidden: true
              },
              {
                name: "errorColor-10pct",
                value: undefined,
                hidden: true
              },
              {
                name: "errorTextColor",
                value: undefined,
                userDefined: false
              },
              {
                name: "errorContrastColor",
                value: undefined,
                userDefined: false,
              },
              {
                name: "successColor",
                value: undefined,
                userDefined: false,
              },
              {
                name: "successColor-50pct",
                value: undefined,
                hidden: true
              },
              {
                name: "successColor-10pct",
                value: undefined,
                hidden: true
              },
              {
                name: "successTextColor",
                value: undefined,
                userDefined: false
              },
              {
                name: "successContrastColor",
                value: undefined,
                userDefined: false,
              }
            ]
          },

          dark: {
            type: Array,
            value: function() {
              return JSON.parse(JSON.stringify(this.light));
            }
          },

          contrast: {
            type: Number,
            value: 70,
            observer: '_contrastChanged'
          },

          borderRadius: {
            type: Number,
            value: 4,
            observer: '_borderRadiusChanged'
          }
        }
      }

      _getColorIndexByName(array, name) {
        let index = -1;
        array.forEach(function(color, i) {
          if (color.name == name) {
            index = i;
          }
        });
        return index;
      }

      _getColor(theme, name) {
        return this[theme][this._getColorIndexByName(this[theme], name)];
      }

      _setColor(theme, name, value) {
        this.set(`${theme}.${this._getColorIndexByName(this[theme], name)}.value`, value);
      }

      _colorChanged(e) {
        this.set(e.target.path + ".userDefined", true);
        this.set(e.target.path + ".value", e.target.value);
        this._updateStyles();
      }

      _clearColor(e) {
        let color = e.target.path.split(".");
        this.set(e.target.path + ".userDefined", false);
        this._clearStyles();
        this.set(e.target.path + ".value", this._getColorValue(this[color[0]][color[1]], color[0]));
        this._updateStyles();
      }

      _getColorValue(color, theme) {
        if (color.userDefined) {
          return color.value;
        }

        let propertyName = this._getColorPropertyName(color.name);
        document.body.setAttribute("theme", theme);
        let value = getComputedStyle(document.body).getPropertyValue(propertyName).trim();
        document.body.removeAttribute("theme");
        // let value = getComputedStyle(this.root.querySelector(`[theme="${theme}"]`)).getPropertyValue(propertyName).trim();
        if (value) {
          return tinycolor(value).toHexString();
        }
        return undefined;
      }

      _getColorPropertyName(name) {
        return "--valo-" + name.replace(/([A-Z])/g, function($1) {
          return "-" + $1.toLowerCase();
        });
      }

      ready() {
        super.ready();

        // console.log(document.importNode(this.root.querySelector(".swatches").content, true));
        // this.appendChild(document.importNode(this.root.querySelector(".swatches").content, true));
        this.root.querySelector(".dark-controls .grayscale").innerHTML = this.root.querySelector(".light-controls .grayscale").innerHTML;

        this._styles = document.createElement("style");
        this._shadowStyles = document.createElement("style");

        this.appendChild(this._styles);
        this.root.appendChild(this._shadowStyles);

        // Read stylesheet colors
        requestAnimationFrame(function() {
          this.light.forEach(function(color, i) {
            let value = this._getColorValue(color, "light");

            if (!color.userDefined && value) {
              this.set("light." + i + ".value", value);
            }
          }.bind(this));

          this.dark.forEach(function(color, i) {
            let value = this._getColorValue(color, "dark");

            if (!color.userDefined && value) {
              this.set("dark." + i + ".value", value);
            }
          }.bind(this));

          this._updateStyles();
        }.bind(this));
      }

      _contrastChanged(contrast) {
        // Don’t update if the colors have not been initialised yet
        if (this._getColor("light", "primaryColor").value === undefined) {
          return;
        }

        // For some reason the value come in as a string and is not converted to number
        this.contrast = parseInt(contrast);
        this._updateStyles();
      }

      _updateThemeColors(theme) {
        // Dark theme falls back to light values
        if (theme == "dark") {
          // Primary color
          if (!this._getColor(theme, "primaryColor").userDefined) {
            this._setColor("dark", "primaryColor", this._getColorValue(this._getColor("light", "primaryColor"), "dark"));
          }

          // Error color
          if (!this._getColor(theme, "errorColor").userDefined) {
            this._setColor("dark", "errorColor", this._getColorValue(this._getColor("light", "errorColor"), "dark"));
          }

          // Success color
          if (!this._getColor(theme, "successColor").userDefined) {
            this._setColor("dark", "successColor", this._getColorValue(this._getColor("light", "successColor"), "dark"));
          }
        }

        let primaryColor = this._getColor(theme, "primaryColor");
        let primaryColorHsl = tinycolor(primaryColor.value).toHsl();

        // Primary color variants
        this._setColor(theme, "primaryColor-50pct", tinycolor(primaryColor.value).setAlpha(0.5).toRgbString());
        this._setColor(theme, "primaryColor-10pct", tinycolor(primaryColor.value).setAlpha(0.1).toRgbString());

        // Primary contrast color
        if (!this._getColor(theme, "primaryContrastColor").userDefined) {
          this._setColor(theme, "primaryContrastColor", tinycolor(primaryColor.value).getLuminance() < 0.5 ? "#ffffff" : "#000000");
        }

        // Primary text color
        if (!this._getColor(theme, "primaryTextColor").userDefined) {
          this._setColor(theme, "primaryTextColor", primaryColor.value);
        }

        // Error color variants
        let errorColor = this._getColor(theme, "errorColor");
        this._setColor(theme, "errorColor-50pct", tinycolor(errorColor.value).setAlpha(0.5).toRgbString());
        this._setColor(theme, "errorColor-10pct", tinycolor(errorColor.value).setAlpha(0.1).toRgbString());

        // Error text color
        if (!this._getColor(theme, "errorTextColor").userDefined) {
          this._setColor(theme, "errorTextColor", this._getColor(theme, "errorColor").value);
        }

        // Error contrast color
        if (!this._getColor(theme, "errorContrastColor").userDefined) {
          this._setColor(theme, "errorContrastColor", tinycolor(errorColor.value).getLuminance() < 0.5 ? "#ffffff" : "#000000");
        }

        // Success color variants
        let successColor = this._getColor(theme, "successColor");
        this._setColor(theme, "successColor-50pct", tinycolor(successColor.value).setAlpha(0.5).toRgbString());
        this._setColor(theme, "successColor-10pct", tinycolor(successColor.value).setAlpha(0.1).toRgbString());

        // Success text color
        if (!this._getColor(theme, "successTextColor").userDefined) {
          this._setColor(theme, "successTextColor", this._getColor(theme, "successColor").value);
        }

        // Success contrast color
        if (!this._getColor(theme, "successContrastColor").userDefined) {
          this._setColor(theme, "successContrastColor", tinycolor(successColor.value).getLuminance() < 0.5 ? "#ffffff" : "#000000");
        }

        // Base color (not computed for light theme)
        let baseColor = this._getColor(theme, "baseColor");
        let baseColorHsl = tinycolor(baseColor.value).toHsl();

        if (theme == "dark") {
          if (!this._getColor(theme, "baseColor").userDefined) {
            // Fall back to shading based on  primary color
            let hue = parseInt(primaryColorHsl.h);
            let saturation = primaryColorHsl.s;

            let baseColor = tinycolor(`hsl(${hue}, ${parseInt(saturation / 3.33 * 100)}%, ${100-this.contrast}%)`);
            this._setColor(theme, "baseColor", baseColor.toHexString());
          }
        }

        // Base text color
        if (!this._getColor(theme, "baseTextColor").userDefined) {
          // If base color is white, use primary color for the shading the text
          let hue = baseColorHsl.s > 0 && baseColorHsl.l < 1 ? parseInt(baseColorHsl.h) : parseInt(primaryColorHsl.h);
          let saturation = baseColorHsl.s > 0 && baseColorHsl.l < 1 ? baseColorHsl.s : primaryColorHsl.s;
          let lightness = theme == "light" ? 100-this.contrast : 80 + 20*this.contrast/100;

          let baseTextColor = tinycolor(`hsl(${hue}, ${parseInt(saturation / 3.33 * 100)}%, ${lightness}%)`);
          this._setColor(theme, "baseTextColor", baseTextColor.toHexString());
        }
      }

      _getCssString(theme) {
        let str = (theme == "light") ? "html {\n" : "[theme~='dark'] {\n";

        this[theme].forEach(function(color) {
          if (color.value) {
            str += `\t${this._getColorPropertyName(color.name)}: ${color.value};\n`;
          }
        }.bind(this));


        // Blacks shades (5%-90%)
        let baseColor = this._getColor(theme, theme=="light" ? "baseTextColor" : "baseColor");
        let baseColorHsl = tinycolor(baseColor.value).toHsl();
        let hue = parseInt(baseColorHsl.h);
        let saturation = parseInt(baseColorHsl.s * 100);
        let lightness = parseInt(baseColorHsl.l * 100);

        lightness -= parseInt(this.contrast / (theme=="light"?20:5));

        for (var i = 0; i <= 90; i = i + 10) {
          // Start from 5%
          if (i == 0) i = 5;

          // Alpha
          let alpha = i / 100 + (100 - i) * this.contrast / 1000000;
          str += `\t--valo-black-${i}pct: hsla(${hue}, ${saturation}%, ${lightness}%, ${alpha});\n`;

          // Continue next with 10%
          if (i == 5) i = 0;
        }

        // Main black
        str += `\t--valo-black:      hsl(${hue}, ${saturation}%, ${lightness}%);\n\n`;


        // White tints (5%-90%)
        baseColor = this._getColor(theme, theme=="light" ? "baseColor" : "baseTextColor");
        baseColorHsl = tinycolor(baseColor.value).toHsl();
        hue = parseInt(baseColorHsl.h);
        saturation = parseInt(baseColorHsl.s * 100);
        lightness = parseInt(baseColorHsl.l * 100);

        lightness += parseInt(this.contrast / 5);

        for (var i = 0; i <= 90; i = i + 10) {
          // Start from 5%
          if (i == 0) i = 5;

          // Alpha
          let alpha = i / 100 + (100 - i) * this.contrast / 1000000;
          str += `\t--valo-white-${i}pct: hsla(${hue}, ${saturation}%, ${lightness}%, ${alpha});\n`;

          // Continue next with 10%
          if (i == 5) i = 0;
        }

        // Main white
        str += `\t--valo-white:      hsl(${hue}, ${saturation}%, ${lightness}%);\n\n`;


        // Contrast colors
        str +=
          `
    --valo-contrast-5pct:  var(--valo-${ theme=="light" ? "black" : "white" }-5pct);
    --valo-contrast-10pct: var(--valo-${ theme=="light" ? "black" : "white" }-10pct);
    --valo-contrast-20pct: var(--valo-${ theme=="light" ? "black" : "white" }-20pct);
    --valo-contrast-30pct: var(--valo-${ theme=="light" ? "black" : "white" }-30pct);
    --valo-contrast-40pct: var(--valo-${ theme=="light" ? "black" : "white" }-40pct);
    --valo-contrast-50pct: var(--valo-${ theme=="light" ? "black" : "white" }-50pct);
    --valo-contrast-60pct: var(--valo-${ theme=="light" ? "black" : "white" }-60pct);
    --valo-contrast-70pct: var(--valo-${ theme=="light" ? "black" : "white" }-70pct);
    --valo-contrast-80pct: var(--valo-${ theme=="light" ? "black" : "white" }-80pct);
    --valo-contrast-90pct: var(--valo-${ theme=="light" ? "black" : "white" }-90pct);
    --valo-contrast:       var(--valo-${ theme=="light" ? "black" : "white" });
}
`;
        return str;
      }

      _clearStyles() {
        this._styles.innerHTML = this._shadowStyles.innerHTML = "";
      }

      _updateStyles() {
        this._updateThemeColors("light");
        this._updateThemeColors("dark");

        let lightTheme = this._getCssString("light");
        let darkTheme = this._getCssString("dark");

        let styleStr = lightTheme + "\n\n" + darkTheme;
        styleStr += `
html {
  --valo-border-radius: ${this.borderRadius}px;
}
        `;

        if (this._styles && this._shadowStyles) {
          this._styles.innerHTML = this._shadowStyles.innerHTML = styleStr;
        }
      }

      _borderRadiusChanged() {
        this._updateStyles();
      }
    }

    customElements.define(ValoConfig.is, ValoConfig);

  </script>
</dom-module>
